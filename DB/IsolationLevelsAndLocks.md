# üìå –£—Ä–æ–≤–Ω–∏ –∏–∑–æ–ª—è—Ü–∏–∏ –∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏: –∫–ª—é—á–µ–≤—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ –¥–ª—è —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏—è

## 1. –ß–µ—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ø–æ–Ω—è—Ç–∏–π

### –£—Ä–æ–≤–Ω–∏ –∏–∑–æ–ª—è—Ü–∏–∏ (Isolation Levels)
- **–ß—Ç–æ —ç—Ç–æ?**  
  –ü—Ä–∞–≤–∏–ª–∞, –æ–ø—Ä–µ–¥–µ–ª—è—é—â–∏–µ, –∫–∞–∫ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤–∏–¥—è—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥—Ä—É–≥ –¥—Ä—É–≥–∞ (ANSI SQL —Å—Ç–∞–Ω–¥–∞—Ä—Ç).

- **–ó–∞—á–µ–º?**  
  –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–º –¥–æ—Å—Ç—É–ø–µ.

- **4 —É—Ä–æ–≤–Ω—è (–æ—Ç —Å–ª–∞–±—ã—Ö –∫ —Å—Ç—Ä–æ–≥–∏–º):**
    1. `READ UNCOMMITTED` ‚Üí –í–∏–¥–Ω—ã "–≥—Ä—è–∑–Ω—ã–µ" –¥–∞–Ω–Ω—ã–µ (–≤ PostgreSQL –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è).
    2. `READ COMMITTED` ‚Üí –í–∏–¥–Ω—ã —Ç–æ–ª—å–∫–æ –∫–æ–º–º–∏—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–¥–µ—Ñ–æ–ª—Ç –≤ PostgreSQL).
    3. `REPEATABLE READ` ‚Üí –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –ø–æ–≤—Ç–æ—Ä—è–µ–º–æ—Å—Ç—å —á—Ç–µ–Ω–∏—è.
    4. `SERIALIZABLE` ‚Üí –ü–æ–ª–Ω–∞—è –∏–∑–æ–ª—è—Ü–∏—è, –∫–∞–∫ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ.

### –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏ (Locks)
- **–ß—Ç–æ —ç—Ç–æ?**  
  –ú–µ—Ö–∞–Ω–∏–∑–º –°–£–ë–î –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —É—Ä–æ–≤–Ω–µ–π –∏–∑–æ–ª—è—Ü–∏–∏.

- **–ü—Ä–∏–º–µ—Ä—ã –≤ PostgreSQL:**
    - `FOR UPDATE` ‚Üí –≠–∫—Å–∫–ª—é–∑–∏–≤–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å—Ç—Ä–æ–∫–∏.
    - `FOR SHARE` ‚Üí –°–æ–≤–º–µ—Å—Ç–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞.
    - Advisory Locks ‚Üí –ö–∞—Å—Ç–æ–º–Ω—ã–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

---

## 2. –ö–∞–∫ —ç—Ç–æ —Å–≤—è–∑–∞–Ω–æ –≤ Hibernate?

### –û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—ã–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ (Optimistic Locking)
- **–ú–µ—Ö–∞–Ω–∏–∑–º:**  
  –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–æ–ª–µ `@Version` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π.

- **–ö–æ–¥:**
  ```java
  @Entity
  public class Order {
  @Version
  private Long version; // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏—Ä—É–µ—Ç—Å—è
  }
  ```

- **–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–æ–¥ –∫–∞–ø–æ—Ç–æ–º:**
  ```sql
  UPDATE orders SET ..., version = version + 1
  WHERE id = 123 AND version = 5;
  ```
  –ï—Å–ª–∏ –≤–µ—Ä—Å–∏—è –∏–∑–º–µ–Ω–∏–ª–∞—Å—å ‚Üí `OptimisticLockException`.

- **–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**  
  –ù–∏–∑–∫–∞—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏—è, –¥–æ–ª–≥–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã.

### –ü–µ—Å—Å–∏–º–∏—Å—Ç–∏—á–Ω—ã–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ (Pessimistic Locking)
- **–ú–µ—Ö–∞–Ω–∏–∑–º:**  
  –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î —á–µ—Ä–µ–∑ `SELECT ... FOR UPDATE`.

- **–ö–æ–¥:**
  ```java
  Order order = entityManager.find(
  Order.class,
  1L,
  LockModeType.PESSIMISTIC_WRITE
  );
  ```

- **–ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º—ã–π SQL:**
  ```sql
  SELECT * FROM orders WHERE id = 1 FOR UPDATE;
  ```

- **–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**  
  –í—ã—Å–æ–∫–∞—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏—è, –∫–æ—Ä–æ—Ç–∫–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏.

---

## 3. –¢–∏–ø–æ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã –Ω–∞ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–∏

### –í–æ–ø—Ä–æ—Å 1:
**"–ß–µ–º –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è READ COMMITTED –æ—Ç REPEATABLE READ –≤ PostgreSQL?"**

**–û—Ç–≤–µ—Ç:**
- `READ COMMITTED`:
    - –í–∏–¥–Ω—ã —Ç–æ–ª—å–∫–æ –∫–æ–º–º–∏—á–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è.
    - –í–æ–∑–º–æ–∂–Ω—ã **–Ω–µ–ø–æ–≤—Ç–æ—Ä—è–µ–º–æ–µ —á—Ç–µ–Ω–∏–µ** (–¥–≤–∞ SELECT –≤ –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –º–æ–≥—É—Ç –≤–µ—Ä–Ω—É—Ç—å —Ä–∞–∑–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ).

- `REPEATABLE READ`:
    - "–°–Ω–∏–º–æ–∫" –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –º–æ–º–µ–Ω—Ç –ø–µ—Ä–≤–æ–≥–æ SELECT.
    - –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ SELECT –≤–µ—Ä–Ω—É—Ç —Ç–µ –∂–µ –¥–∞–Ω–Ω—ã–µ.
    - –í PostgreSQL –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —Ñ–∞–Ω—Ç–æ–º—ã —á–µ—Ä–µ–∑ Snapshot Isolation.

### –í–æ–ø—Ä–æ—Å 2:
**"–ö–∞–∫ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å OptimisticLockException?"**

**–û—Ç–≤–µ—Ç:**
- –í–∞—Ä–∏–∞–Ω—Ç—ã:
    1. **Retry**: –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é —Å –Ω–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏.
    2. **–ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É**: –£–≤–µ–¥–æ–º–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–µ.
- –ü—Ä–∏–º–µ—Ä:
  ```java
  try {
  orderService.updateOrder(order);
  } catch (OptimisticLockException ex) {
  // "–î–∞–Ω–Ω—ã–µ –±—ã–ª–∏ –∏–∑–º–µ–Ω–µ–Ω—ã. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É."
  }
  ```

### –í–æ–ø—Ä–æ—Å 3:
**"–ß—Ç–æ —Ç–∞–∫–æ–µ deadlock –∏ –∫–∞–∫ –µ–≥–æ –∏–∑–±–µ–∂–∞—Ç—å?"**

**–û—Ç–≤–µ—Ç:**
- **Deadlock** ‚Üí –í–∑–∞–∏–º–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π (A –∂–¥–µ—Ç B, B –∂–¥–µ—Ç A).
- **–°–ø–æ—Å–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å:**
    - –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Ä–µ—Å—É—Ä—Å–æ–≤.
    - –ö–æ—Ä–æ—Ç–∫–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.
    - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `NOWAIT` –∏–ª–∏ `SKIP LOCKED`.
    - –ù–∞—Å—Ç—Ä–æ–π–∫–∞ `lock_timeout`.

---

## 4. PostgreSQL vs Hibernate: –∫–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

### PostgreSQL
- **READ COMMITTED** ‚Üí –î–µ—Ñ–æ–ª—Ç–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å.
- **REPEATABLE READ** ‚Üí –ù–µ—Ç —Ñ–∞–Ω—Ç–æ–º–æ–≤ (–≤ –æ—Ç–ª–∏—á–∏–µ –æ—Ç –¥—Ä—É–≥–∏—Ö –°–£–ë–î).
- **SERIALIZABLE** ‚Üí –î–æ—Ä–æ–≥–æ, –Ω–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –ø–æ–ª–Ω—É—é –∏–∑–æ–ª—è—Ü–∏—é.

### Hibernate
- **–û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—ã–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏:**  
  –¢—Ä–µ–±—É—é—Ç `@Version` –∏ —É—Ä–æ–≤–µ–Ω—å –∏–∑–æ–ª—è—Ü–∏–∏ ‚â• `READ COMMITTED`.
- **–ü–µ—Å—Å–∏–º–∏—Å—Ç–∏—á–Ω—ã–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏:**  
  –ü—Ä–æ–∑—Ä–∞—á–Ω–æ –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç `FOR UPDATE/SHARE`.
- **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–∑–æ–ª—è—Ü–∏–∏:**  
  –ß–µ—Ä–µ–∑ `@Transactional(isolation = Isolation.LEVEL)`.

---

## 5. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–≤–µ—Ç—ã –¥–ª—è Middle —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞

### –î–ª—è —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏—è:
- **–ì–æ–≤–æ—Ä–∏—Ç–µ –ø—Ä–∏–º–µ—Ä–∞–º–∏:**  
  "–ï—Å–ª–∏ –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º `@Version`, Hibernate –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–∏—Ç –ø—Ä–æ–≤–µ—Ä–∫—É –≤–µ—Ä—Å–∏–∏ –≤ UPDATE-–∑–∞–ø—Ä–æ—Å".
- **–£–ø–æ–º—è–Ω–∏—Ç–µ trade-offs:**  
  "–ü–µ—Å—Å–∏–º–∏—Å—Ç–∏—á–Ω—ã–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Å–Ω–∏–∂–∞—é—Ç –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏—é, –Ω–æ –º–æ–≥—É—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –¥–µ–¥–ª–æ–∫–∞–º".
- **–°—Å—ã–ª–∞–π—Ç–µ—Å—å –Ω–∞ –æ–ø—ã—Ç:**  
  "–í –º–æ–µ–º –ø—Ä–æ–µ–∫—Ç–µ –º—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—ã–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –¥–ª—è –∫–æ—Ä–∑–∏–Ω—ã –ø–æ–∫—É–ø–æ–∫, —Ç–∞–∫ –∫–∞–∫ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –±—ã–ª–∏ —Ä–µ–¥–∫–∏".

### –í —Ä–µ–∞–ª—å–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–∞—Ö:
- **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:**  
  ```sql
  SELECT * FROM pg_locks; -- –¢–µ–∫—É—â–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
  SELECT * FROM pg_stat_activity; -- –ê–∫—Ç–∏–≤–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
  ```
- **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–∞–π–º–∞—É—Ç–æ–≤:**  
  ```java
  @QueryHints(@QueryHint(name = "javax.persistence.lock.timeout", value = "3000"))
  ```
- **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**  
  –ò–º–∏—Ç–∏—Ä—É–π—Ç–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã–π –¥–æ—Å—Ç—É–ø —á–µ—Ä–µ–∑ `@Transactional` + `CountDownLatch`.

---

## 6. –ß–µ–∫–ª–∏—Å—Ç –¥–ª—è —Å–∞–º–æ–ø—Ä–æ–≤–µ—Ä–∫–∏

‚úÖ –ó–Ω–∞—é 4 —É—Ä–æ–≤–Ω—è –∏–∑–æ–ª—è—Ü–∏–∏ ANSI SQL –∏ –∏—Ö –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –≤ PostgreSQL.  
‚úÖ –ú–æ–≥—É –æ–±—ä—è—Å–Ω–∏—Ç—å —Ä–∞–∑–Ω–∏—Ü—É –º–µ–∂–¥—É –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—ã–º–∏ –∏ –ø–µ—Å—Å–∏–º–∏—Å—Ç–∏—á–Ω—ã–º–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞–º–∏.  
‚úÖ –ü–æ–Ω–∏–º–∞—é, –∫–∞–∫ `@Version` –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —É—Å–ª–æ–≤–∏—è –≤ SQL.  
‚úÖ –ó–Ω–∞—é, –∫–∞–∫ –∏–∑–±–µ–≥–∞—Ç—å –¥–µ–¥–ª–æ–∫–æ–≤ –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å `OptimisticLockException`.  
‚úÖ –£–º–µ—é –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å —É—Ä–æ–≤–Ω–∏ –∏–∑–æ–ª—è—Ü–∏–∏ —á–µ—Ä–µ–∑ `@Transactional`.