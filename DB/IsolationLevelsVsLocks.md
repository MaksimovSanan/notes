# __–í–æ–∑–º–æ–∂–Ω–æ, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—É—Ç–∞–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ (locks) —Å —É—Ä–æ–≤–Ω—è–º–∏ –∏–∑–æ–ª—è—Ü–∏–∏ (isolation levels), –ø–æ—ç—Ç–æ–º—É —Å—Ç–æ–∏—Ç —Ä–∞–∑–≥—Ä–∞–Ω–∏—á–∏—Ç—å —ç—Ç–∏ –ø–æ–Ω—è—Ç–∏—è. –£—Ä–æ–≤–Ω–∏ –∏–∑–æ–ª—è—Ü–∏–∏ –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç —Å—Ç–µ–ø–µ–Ω—å –∏–∑–æ–ª—è—Ü–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π, –∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ ‚Äî —ç—Ç–æ –º–µ—Ö–∞–Ω–∏–∑–º—ã, –∫–æ—Ç–æ—Ä—ã–µ –°–£–ë–î –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —ç—Ç–∏—Ö —É—Ä–æ–≤–Ω–µ–π.__

___

# üìå –£—Ä–æ–≤–Ω–∏ –∏–∑–æ–ª—è—Ü–∏–∏, –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ PostgreSQL –∏ Hibernate: –∫–∞–∫ –æ–Ω–∏ —Å–≤—è–∑–∞–Ω—ã

## 1. –£—Ä–æ–≤–Ω–∏ –∏–∑–æ–ª—è—Ü–∏–∏ vs –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏: –ë–∞–∑–æ–≤–∞—è –∫–æ–Ω—Ü–µ–ø—Ü–∏—è

- **–£—Ä–æ–≤–Ω–∏ –∏–∑–æ–ª—è—Ü–∏–∏** (Isolation Levels):
    - –û–ø—Ä–µ–¥–µ–ª—è—é—Ç, *–∫–∞–∫–∏–µ –∞–Ω–æ–º–∞–ª–∏–∏* –¥–æ–ø—É—Å–∫–∞—é—Ç—Å—è –º–µ–∂–¥—É –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–º–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏.
    - –†–µ–≥–ª–∞–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã —Å—Ç–∞–Ω–¥–∞—Ä—Ç–æ–º SQL (ANSI): `READ UNCOMMITTED`, `READ COMMITTED`, `REPEATABLE READ`, `SERIALIZABLE`.

- **–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏** (Locks):
    - *–ú–µ—Ö–∞–Ω–∏–∑–º—ã —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏* —É—Ä–æ–≤–Ω–µ–π –∏–∑–æ–ª—è—Ü–∏–∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ –°–£–ë–î (–Ω–∞–ø—Ä–∏–º–µ—Ä, PostgreSQL).
    - –ü—Ä–∏–º–µ—Ä—ã: `FOR UPDATE`, `FOR SHARE`, Advisory Locks.

---

## 2. –£—Ä–æ–≤–Ω–∏ –∏–∑–æ–ª—è—Ü–∏–∏ –≤ PostgreSQL

### –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —É—Ä–æ–≤–Ω–∏:
| –£—Ä–æ–≤–µ–Ω—å              | –ì—Ä—è–∑–Ω–æ–µ —á—Ç–µ–Ω–∏–µ | –ù–µ–ø–æ–≤—Ç–æ—Ä—è–µ–º–æ–µ —á—Ç–µ–Ω–∏–µ | –§–∞–Ω—Ç–æ–º—ã |
|----------------------|----------------|-----------------------|---------|
| **READ UNCOMMITTED** | ‚ùå             | ‚ùå                    | ‚ùå      |
| **READ COMMITTED**   | ‚úÖ             | ‚ùå                    | ‚ùå      |
| **REPEATABLE READ**  | ‚úÖ             | ‚úÖ                    | ‚ùå      |
| **SERIALIZABLE**     | ‚úÖ             | ‚úÖ                    | ‚úÖ      |

> ‚ö†Ô∏è –í PostgreSQL `READ UNCOMMITTED` —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ `READ COMMITTED` ([–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è](https://www.postgresql.org/docs/current/transaction-iso.html)).

---

## 3. –ö–∞–∫ Hibernate –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —É—Ä–æ–≤–Ω–∏ –∏–∑–æ–ª—è—Ü–∏–∏

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —á–µ—Ä–µ–∑ –∞–Ω–Ω–æ—Ç–∞—Ü–∏—é `@Transactional`:
```java
@Transactional(isolation = Isolation.READ_COMMITTED)
public void updateOrder(Long orderId) {
// ... –ª–æ–≥–∏–∫–∞
}
```

**–î–æ—Å—Ç—É–ø–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã** (–∏–∑ `org.springframework.transaction.annotation.Isolation`):
- `DEFAULT` ‚Üí –£—Ä–æ–≤–µ–Ω—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –°–£–ë–î (–¥–ª—è PostgreSQL: `READ COMMITTED`)
- `READ_UNCOMMITTED`
- `READ_COMMITTED`
- `REPEATABLE_READ`
- `SERIALIZABLE`

---

## 4. –û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—ã–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –≤ Hibernate

### –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ `@Version`:
```java
@Entity
public class Order {
@Id
private Long id;

    @Version
    private Integer version;
    // ... –¥—Ä—É–≥–∏–µ –ø–æ–ª—è
}
```

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç**:
1. –ü—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Å—É—â–Ω–æ—Å—Ç–∏ Hibernate —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤–µ—Ä—Å–∏—é.
2. –ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç —É—Å–ª–æ–≤–∏–µ `WHERE version = :oldVersion`.
3. –ï—Å–ª–∏ –≤–µ—Ä—Å–∏—è –∏–∑–º–µ–Ω–∏–ª–∞—Å—å ‚Üí –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç `OptimisticLockException`.

**–°–≤—è–∑—å —Å —É—Ä–æ–≤–Ω—è–º–∏ –∏–∑–æ–ª—è—Ü–∏–∏**:
- –¢—Ä–µ–±—É–µ—Ç –∫–∞–∫ –º–∏–Ω–∏–º—É–º `READ COMMITTED` (—á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –≤–µ—Ä—Å–∏–∏).
- –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–µ—Å—Å–∏–º–∏—Å—Ç–∏—á–Ω—ã–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î.

---

## 5. –ü–µ—Å—Å–∏–º–∏—Å—Ç–∏—á–Ω—ã–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –≤ Hibernate

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `LockModeType`:
```java
Order order = entityManager.find(
Order.class,
1L,
LockModeType.PESSIMISTIC_WRITE
);
```

**–ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º—ã–π SQL**:
```sql
SELECT * FROM orders WHERE id = 1 FOR UPDATE;
```

**–¢–∏–ø—ã –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫**:
| –†–µ–∂–∏–º                | SQL                  | –û–ø–∏—Å–∞–Ω–∏–µ                     |
|----------------------|----------------------|------------------------------|
| `PESSIMISTIC_READ`   | `FOR SHARE`          | –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –Ω–∞ —á—Ç–µ–Ω–∏–µ         |
| `PESSIMISTIC_WRITE`  | `FOR UPDATE`         | –≠–∫—Å–∫–ª—é–∑–∏–≤–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞      |
| `PESSIMISTIC_FORCE_INCREMENT` | `FOR UPDATE` + –≤–µ—Ä—Å–∏—è | –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ + –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–∏ |

---

## 6. –ö–∞–∫ –≤—ã–±—Ä–∞—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏—é?

### –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **–æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—ã–µ** –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏:
- –ù–∏–∑–∫–∞—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏—è –∑–∞ –¥–∞–Ω–Ω—ã–µ.
- –î–æ–ª–≥–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, UI-—Ñ–æ—Ä–º—ã).
- –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã.

### –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **–ø–µ—Å—Å–∏–º–∏—Å—Ç–∏—á–Ω—ã–µ** –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏:
- –í—ã—Å–æ–∫–∞—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏—è –∑–∞ –æ–¥–Ω–∏ –¥–∞–Ω–Ω—ã–µ.
- –ö–æ—Ä–æ—Ç–∫–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.
- –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–ø–∏—Å–∞–Ω–∏–µ –¥–µ–Ω–µ–≥).

---

## 7. –ü—Ä–∏–º–µ—Ä: –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥—Ö–æ–¥–æ–≤

```java
@Transactional(isolation = Isolation.REPEATABLE_READ)
public void processOrder(Long orderId) {
// –ü–µ—Å—Å–∏–º–∏—Å—Ç–∏—á–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –Ω–∞ —á—Ç–µ–Ω–∏–µ
Order order = entityManager.find(
Order.class,
orderId,
LockModeType.PESSIMISTIC_WRITE
);

    // –û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ –≤–µ—Ä—Å–∏—é
    if (order.getStatus() == Status.NEW) {
        order.setStatus(Status.PROCESSING);
    }
    
    entityManager.flush(); // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–∏ –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç –∑–¥–µ—Å—å
}
```

---

## 8. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è PostgreSQL

- **–ù–µ—Ç "–≥—Ä—è–∑–Ω–æ–≥–æ —á—Ç–µ–Ω–∏—è"** ‚Üí `READ UNCOMMITTED` –Ω–µ –∏–º–µ–µ—Ç —Å–º—ã—Å–ª–∞.
- **REPEATABLE READ vs SERIALIZABLE**:
    - –í PostgreSQL `REPEATABLE READ` –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —Ñ–∞–Ω—Ç–æ–º—ã —á–µ—Ä–µ–∑ *snapshot isolation*.
    - `SERIALIZABLE` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç *predicate locking* (–±–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–æ, –Ω–æ –¥–æ—Ä–æ–∂–µ).

---

## 9. –°–æ–≤–µ—Ç—ã –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ Hibernate

1. **–î–ª—è –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—ã—Ö –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫**:
```properties
# application.properties
spring.jpa.properties.hibernate.connection.isolation=2 # READ_COMMITTED
```

2. **–î–ª—è –ø–µ—Å—Å–∏–º–∏—Å—Ç–∏—á–Ω—ã—Ö –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫**:
   ```java
   @QueryHints({
   @QueryHint(
   name = "javax.persistence.lock.timeout",
   value = "5000" // 5 —Å–µ–∫ –æ–∂–∏–¥–∞–Ω–∏—è
   )
   })
   @Query("SELECT o FROM Order o WHERE o.id = :id")
   Order findWithLock(@Param("id") Long id);
   ```

3. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**:
   ```sql
   SELECT * FROM pg_locks WHERE pid = [–≤–∞—à PID];
   ```

---

## üî• –ò—Ç–æ–≥

- **–£—Ä–æ–≤–Ω–∏ –∏–∑–æ–ª—è—Ü–∏–∏** ‚Üí –û–ø—Ä–µ–¥–µ–ª—è—é—Ç *—á—Ç–æ* —Ä–∞–∑—Ä–µ—à–µ–Ω–æ (–∞–Ω–æ–º–∞–ª–∏–∏).
- **–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏** ‚Üí –†–µ–∞–ª–∏–∑—É—é—Ç *–∫–∞–∫* –¥–æ—Å—Ç–∏–≥–∞–µ—Ç—Å—è –∏–∑–æ–ª—è—Ü–∏—è.
- **Hibernate** ‚Üí –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –∞–±—Å—Ç—Ä–∞–∫—Ü–∏—é –Ω–∞–¥:
    - –£—Ä–æ–≤–Ω—è–º–∏ –∏–∑–æ–ª—è—Ü–∏–∏ –°–£–ë–î (`@Transactional`).
    - –û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—ã–º–∏ (`@Version`) –∏ –ø–µ—Å—Å–∏–º–∏—Å—Ç–∏—á–Ω—ã–º–∏ (`LockModeType`) –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞–º–∏.

–í—ã–±–æ—Ä —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å—Ü–µ–Ω–∞—Ä–∏—è: –∫–æ–º–±–∏–Ω–∏—Ä—É–π—Ç–µ –ø–æ–¥—Ö–æ–¥—ã –¥–ª—è –±–∞–ª–∞–Ω—Å–∞ –º–µ–∂–¥—É –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é –∏ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å—é!